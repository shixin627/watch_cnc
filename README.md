# 2.5D 弧面等厚掃描加工程式

## 專案說明

本專案提供 **XZ 平面弧面薄壁** 的 2.5D 連續掃描加工 G-code 解決方案，適用於 Mach3 CNC 控制系統。

### 加工策略核心

- **加工對象**: 立體弧面薄壁（位於 XZ 平面）
- **加工厚度**: 1.0 mm（總深度）
- **分層策略**: 10 層 × 0.1 mm/層
- **路徑特性**: 連續掃描、不抬刀、沿弧面等厚剝離
- **掃描方向**: Y 軸（0.0 → 0.4 mm）

---

## 檔案清單

| 檔案名稱 | 說明 | 適用情境 |
|---------|------|---------|
| `ver0.txt` | 原始版本（有問題） | ❌ 不建議使用 - Z 深度未跟隨弧面 |
| `optimized_arc_scan.nc` | **完整 Macro B 版本** | ✅ 推薦 - 支援 WHILE 循環的 Mach3 |
| `zigzag_optimized.nc` | **鋸齒優化版本** | ✅ 最佳效率 - 減少 50% 空切 |
| `expanded_arc_scan.nc` | 展開版範例 | 🔧 舊版 Mach3（參考框架） |
| `generate_gcode.py` | **Python 生成器** | ⭐ 彈性最高 - 可自訂所有參數 |
| `README.md` | 本說明文件 | 📖 |

---

## 快速開始

### 方案 1: 直接使用預生成 G-code

**最簡單的方式 - 鋸齒優化版**

```bash
# 直接載入到 Mach3
檔案 → 載入 G-code → 選擇 zigzag_optimized.nc
```

**參數（已預設）:**
- 圓心: (X=0, Z=-10)
- 初始半徑: R₀ = 10 mm
- 掃描寬度: Y = 0.0 ~ 0.4 mm
- 步距: ΔX = 0.2 mm

### 方案 2: 使用 Python 生成器（推薦客製化）

**安裝 Python 3**（若尚未安裝）

**生成 G-code:**

```bash
# 基本用法（鋸齒優化）
python generate_gcode.py > my_output.nc

# 不使用鋸齒優化
python generate_gcode.py --no-zigzag > standard_output.nc
```

**修改參數（編輯 `generate_gcode.py`）:**

```python
# 第 10-22 行
XC = 0.0            # 弧面頂點 X 座標
ZC = -10.0          # 圓心 Z 座標
R0 = 10.0           # 初始外層半徑
Y0 = 0.0            # 掃描起始 Y
Y1 = 0.4            # 掃描結束 Y
DEPTH_PER_LAYER = 0.1   # 每層深度
TOTAL_LAYERS = 10       # 總層數
DX = 0.2                # X 步距
FEED_RATE = 20          # 進給速率
```

---

## 加工路徑邏輯

### 單層掃描順序（標準版）

每層執行以下閉合路徑：

```
1) Xc → X_start  @ Y0  (沿弧面下降到左側)
2) Y0 → Y1             (橫向移動)
3) X_start → Xc  @ Y1  (沿弧面上升到中心)
4) Xc → X_end    @ Y1  (沿弧面下降到右側)
5) Y1 → Y0             (橫向回掃)
6) X_end → Xc    @ Y0  (沿弧面上升回中心)
```

### 鋸齒優化版改進

- **奇數層 (1, 3, 5...)**: 左 → 中 → 右
- **偶數層 (2, 4, 6...)**: 右 → 中 → 左

**效果**:
- 減少層間長距離空切移動
- 提升加工效率約 30-50%

---

## 幾何模型

### 弧面方程

```
Z_arc(X) = Zc - √(R² - (X - Xc)²)
```

### 實際加工 Z 值

```
Z_actual = min(Z_arc, Z_layer)
```

確保刀具不會切超過當前層深度。

### 第 k 層參數

```
Z_layer = -0.1 × k
R_layer = R₀ - 0.1 × k
```

**關鍵**: Z 深度與半徑同步縮小，實現等厚剝離。

---

## 原版問題分析 (ver0.txt)

### ❌ 主要問題

1. **Z 深度固定**
   - 每層只有一個 `G1 Z-0.X`
   - 沒有隨 X 座標變化的 Z 值
   - **違反弧面跟隨原則**

2. **路徑不符合弧面**
   - 實際上是平面 XY 掃描
   - Z 只在層間改變，層內保持恆定
   - 無法實現「沿弧面等厚剝離」

### ✅ 正確實作

```gcode
; 錯誤（ver0.txt）
G1 Z-0.1        ; 固定深度
G1 X12.2        ; Z 不變
G1 Y0.4
G1 X-12.2

; 正確（新版本）
WHILE [X >= X_start]
  Z = Zc - SQRT(R² - (X-Xc)²)  ; 每步重新計算 Z
  G1 X... Y... Z...
END
```

---

## 技術規格

### Mach3 相容性

| 功能 | optimized_arc_scan.nc | zigzag_optimized.nc | expanded_arc_scan.nc |
|-----|----------------------|---------------------|---------------------|
| WHILE 循環 | ✅ 需要 | ✅ 需要 | ❌ 不需要 |
| 變數運算 | ✅ 需要 | ✅ 需要 | ⚠️ 基本運算 |
| SQRT[] | ✅ 需要 | ✅ 需要 | ✅ 需要 |
| 副程式 (M98/M99) | ✅ 使用 | ✅ 使用 | ❌ 不使用 |

### 程式碼大小估算

- **Macro B 版本**: ~200 行（高效）
- **完整展開版**: ~5000+ 行（DX=0.2, 10層）

---

## 調整建議

### 提高精度

```python
DX = 0.1  # 更小的步距 → 更平滑的弧面
```

⚠️ 副作用: 程式碼行數倍增

### 加快速度

```python
FEED_RATE = 50  # 提高進給速率（根據材料調整）
```

### 改變深度

```python
TOTAL_LAYERS = 20       # 更多層
DEPTH_PER_LAYER = 0.05  # 更淺的下刀
```

---

## 使用注意事項

### ⚠️ 安全檢查

1. **機台限制確認**
   - X/Y/Z 行程範圍
   - 主軸轉速設定（程式未包含，需手動啟動）

2. **空跑測試**
   ```
   - 使用 Mach3 模擬功能
   - Z 軸抬高 50mm 空跑
   - 確認路徑正確
   ```

3. **材料夾持**
   - 確保工件固定牢靠
   - Y 軸方向僅 0.4mm，需精確定位

### 🔧 常見調整

**Q: 弧面方向相反？**
```python
# 修改 Zc 符號
ZC = 10.0  # 原為 -10.0
```

**Q: 需要更大的掃描範圍？**
```python
Y1 = 1.0  # 原為 0.4
```

**Q: Mach3 提示語法錯誤？**
- 檢查是否支援 Macro B
- 嘗試使用 Python 生成器
- 或聯繫技術支援

---

## 驗證方法

### 手動檢查要點

1. **第 1 層**
   - Z_layer = -0.1
   - R_layer = 9.9
   - X_range = √(9.9² - 9.9²) ≈ 0（需實際計算）

2. **第 10 層**
   - Z_layer = -1.0
   - R_layer = 9.0
   - X_range = √(9.0² - 9.0²) ≈ 0

3. **路徑連續性**
   - 每層結束位置 = 下層起始位置 (Xc, Y0)
   - 無抬刀指令（除結束時）

### 模擬工具

- **Mach3 內建模擬器**
- **CAMotics** (開源 G-code 模擬器)
- **NCViewer** (線上工具)

---

## 授權與責任

- 本程式僅供參考，使用前請充分測試
- 實際加工參數需依材料、刀具調整
- 作者不對加工結果負責

---

## 技術支援

若有問題，請提供：
1. 使用的檔案版本
2. Mach3 版本資訊
3. 錯誤訊息截圖
4. 預期與實際結果差異

---

**最後更新**: 2025-12-19
**版本**: 1.0
**作者**: Claude (Anthropic)
