%
; ========================================
; 2.5D 弧面等厚掃描加工程式 (Mach3)
; Arc Surface Constant-Thickness Scanning
; ========================================
;
; 加工策略：
; - 10 層，每層 0.1mm 等厚剝離
; - 弧面位於 XZ 平面，刀具沿 XZ 弧面移動
; - Y 軸掃描寬度 0.4mm
; - 連續路徑，不抬刀
; ========================================

; ========== 可調參數區 ==========
#100 = 0.0          ; Xc - 弧面頂點 X 座標 (圓心 X)
#101 = -10.0        ; Zc - 圓心 Z 座標
#102 = 10.0         ; R0 - 初始外層半徑

#110 = 0.0          ; Y0 - 掃描起始 Y 座標
#111 = 0.4          ; Y1 - 掃描結束 Y 座標

#120 = 0.1          ; 每層深度增量 (mm)
#121 = 10           ; 總層數
#122 = 0.2          ; DX - X 軸步距 (弧面離散精度)

#130 = 20           ; F - 進給速率 (mm/min)
#131 = 5.0          ; 安全高度 Z (刀具退刀高度)

; ========== 初始化 ==========
G90                 ; 絕對座標
G21                 ; 公制單位 (mm)
G40                 ; 取消刀具半徑補償
G49                 ; 取消刀長補償
G80                 ; 取消固定循環

F#130               ; 設定進給速率

; 移動到起始位置
G0 Z#131            ; 快速退到安全高度
G0 X#100 Y#110      ; 移動到弧面頂點 (Xc, Y0)

; ========== 主加工循環 ==========
#200 = 1            ; k - 當前層數計數器

WHILE [#200 LE #121] DO1

  ; ====== 計算當前層參數 ======
  #201 = -#120 * #200                    ; Z_layer = -0.1 * k
  #202 = #102 - #120 * #200              ; R_layer = R0 - 0.1 * k

  ; 計算 X 範圍 (基於圓的幾何)
  ; X_range = sqrt(R^2 - (Zc - Z_layer)^2)
  #203 = #101 - #201                     ; dZ = Zc - Z_layer
  #204 = #202 * #202 - #203 * #203       ; R^2 - dZ^2

  IF [#204 LT 0] THEN #204 = 0           ; 防止負數開方

  #205 = SQRT[#204]                      ; X_range
  #206 = #100 - #205                     ; X_start (左界)
  #207 = #100 + #205                     ; X_end (右界)

  ; 顯示層資訊 (可選，供調試用)
  (MSG, Layer #200: Z=#201 R=#202 X=[#206 to #207])

  ; ====== 單層掃描路徑 ======
  ; 使用副程式 O1000 執行單層掃描
  ; 參數傳遞:
  ;   #206 = X_start
  ;   #207 = X_end
  ;   #201 = Z_layer
  ;   #202 = R_layer
  ;   #200 = k (層號，用於鋸齒優化)

  M98 P1000           ; 呼叫單層掃描副程式

  ; 層數遞增
  #200 = #200 + 1

END1

; ========== 加工完成 ==========
G0 Z#131            ; 退刀到安全高度
G0 X0 Y0            ; 回到原點
M30                 ; 程式結束

; ========================================
; O1000 - 單層掃描副程式
; ========================================
; 輸入參數:
;   #206 = X_start (左界)
;   #207 = X_end (右界)
;   #201 = Z_layer (當前層深)
;   #202 = R_layer (當前層半徑)
;   #200 = k (層號)
; ========================================

O1000

  ; ------ 路徑 1: Xc → X_start @ Y0 ------
  ; 從弧頂下降到左側，沿弧面
  #210 = #100                             ; X 當前位置 = Xc

  WHILE [#210 GE #206] DO2
    ; 計算弧面 Z 值
    #211 = #210 - #100                    ; dX = X - Xc
    #212 = #202 * #202 - #211 * #211      ; R^2 - dX^2
    IF [#212 LT 0] THEN #212 = 0
    #213 = SQRT[#212]                     ; sqrt(R^2 - dX^2)
    #214 = #101 - #213                    ; Z_arc = Zc - sqrt(...)

    ; Z = min(Z_arc, Z_layer)
    IF [#214 GT #201] THEN #214 = #201

    G1 X#210 Y#110 Z#214
    #210 = #210 - #122                    ; X -= DX
  END2

  ; 確保到達 X_start
  G1 X#206 Y#110

  ; ------ 路徑 2: Y0 → Y1 ------
  G1 Y#111

  ; ------ 路徑 3: X_start → Xc @ Y1 ------
  #210 = #206

  WHILE [#210 LE #100] DO3
    #211 = #210 - #100
    #212 = #202 * #202 - #211 * #211
    IF [#212 LT 0] THEN #212 = 0
    #213 = SQRT[#212]
    #214 = #101 - #213
    IF [#214 GT #201] THEN #214 = #201

    G1 X#210 Y#111 Z#214
    #210 = #210 + #122
  END3

  G1 X#100 Y#111

  ; ------ 路徑 4: Xc → X_end @ Y1 ------
  #210 = #100

  WHILE [#210 LE #207] DO4
    #211 = #210 - #100
    #212 = #202 * #202 - #211 * #211
    IF [#212 LT 0] THEN #212 = 0
    #213 = SQRT[#212]
    #214 = #101 - #213
    IF [#214 GT #201] THEN #214 = #201

    G1 X#210 Y#111 Z#214
    #210 = #210 + #122
  END4

  G1 X#207 Y#111

  ; ------ 路徑 5: Y1 → Y0 ------
  G1 Y#110

  ; ------ 路徑 6: X_end → Xc @ Y0 ------
  #210 = #207

  WHILE [#210 GE #100] DO5
    #211 = #210 - #100
    #212 = #202 * #202 - #211 * #211
    IF [#212 LT 0] THEN #212 = 0
    #213 = SQRT[#212]
    #214 = #101 - #213
    IF [#214 GT #201] THEN #214 = #201

    G1 X#210 Y#110 Z#214
    #210 = #210 - #122
  END5

  ; 回到起點 (Xc, Y0)
  G1 X#100 Y#110

M99                 ; 副程式返回

; ========================================
; 程式結束
; ========================================
%
